<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Live Football Scoreboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --primary:      #e8164f;
      --primary-dark: #60032a;
      --primary-deep: #3d0219;
      --accent:       #ffa32b;
      --bg:       #1c1c1a;
      --surface:  #252523;
      --surface2: #2f2f2c;
      --border:   #3a3a37;
      --text:     #ece8e1;
      --muted:    #8a8880;
    }

    body {
      font-family: 'Montserrat', 'Segoe UI', system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }

    /* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
    .header {
      background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary-deep) 100%);
      padding: 14px 24px;
      display: flex; align-items: center; justify-content: space-between;
      border-bottom: 1px solid rgba(255,255,255,.07);
      position: sticky; top: 0; z-index: 100; gap: 12px;
    }
    .header-left  { display: flex; align-items: center; gap: 10px; }
    .header-icon  { font-size: 24px; line-height: 1; }
    .header h1    { font-size: 17px; font-weight: 800; color: #fff; }
    .header-sub   { font-size: 9px; color: rgba(255,255,255,.4); margin-top: 2px; letter-spacing: .8px; font-weight: 600; text-transform: uppercase; }
    .header-right { display: flex; align-items: center; gap: 12px; flex-shrink: 0; }

    .refresh-wrap { display: flex; align-items: center; gap: 8px; }
    .refresh-ring { width: 32px; height: 32px; flex-shrink: 0; }
    .refresh-ring svg { transform: rotate(-90deg); display: block; }
    .ring-bg  { fill: none; stroke: rgba(255,255,255,.12); stroke-width: 3; }
    .ring-arc { fill: none; stroke: var(--accent); stroke-width: 3; stroke-linecap: round;
                stroke-dasharray: 81.68; stroke-dashoffset: 0; transition: stroke-dashoffset 1s linear; }
    .countdown-txt { font-size: 12px; color: var(--accent); font-variant-numeric: tabular-nums; min-width: 32px; font-weight: 700; }

    .btn {
      background: rgba(255,255,255,.1); border: 1px solid rgba(255,255,255,.15);
      color: #fff; padding: 7px 16px; border-radius: 9999px; cursor: pointer;
      font-size: 12px; font-weight: 700; font-family: inherit; transition: background .15s;
      white-space: nowrap;
    }
    .btn:hover { background: rgba(255,255,255,.2); }

    /* ‚îÄ‚îÄ API Setup ‚îÄ‚îÄ */
    #apiSetup {
      background: #1f1018; border: 1px solid rgba(232,22,79,.3);
      border-radius: 16px; padding: 20px 24px; margin: 20px;
      display: flex; align-items: flex-start; gap: 16px; flex-wrap: wrap;
    }
    .setup-text { font-size: 12px; color: rgba(255,255,255,.6); flex: 1; min-width: 220px; line-height: 1.7; font-weight: 500; }
    .setup-text strong { color: var(--text); }
    .setup-text a { color: var(--primary); text-decoration: none; font-weight: 700; }
    .setup-text a:hover { text-decoration: underline; }
    .setup-steps { margin-top: 6px; padding-left: 16px; }
    .setup-steps li { margin-bottom: 2px; }
    .key-row { display: flex; gap: 8px; flex: 2; min-width: 260px; align-self: flex-end; }
    #apiKeyInput {
      flex: 1; min-width: 0; background: rgba(0,0,0,.3);
      border: 1px solid rgba(232,22,79,.3); color: #fff;
      padding: 10px 16px; border-radius: 9999px; font-size: 13px;
      font-family: 'Consolas', monospace;
    }
    #apiKeyInput:focus { outline: none; border-color: var(--primary); }
    #apiKeyInput::placeholder { color: #555; }
    .btn-connect {
      background: var(--primary); border: none; color: #fff;
      padding: 10px 22px; border-radius: 9999px; cursor: pointer;
      font-size: 12px; font-weight: 700; font-family: inherit;
      white-space: nowrap; transition: background .15s;
    }
    .btn-connect:hover { background: #c8103f; }

    /* ‚îÄ‚îÄ Tabs ‚îÄ‚îÄ */
    .tabs {
      display: flex; gap: 2px; padding: 16px 20px 0;
      border-bottom: 1px solid var(--border); overflow-x: auto;
    }
    .tab {
      padding: 8px 18px; border-radius: 7px 7px 0 0; cursor: pointer;
      font-size: 11px; font-weight: 700; letter-spacing: .3px; color: var(--muted);
      border: 1px solid transparent; border-bottom: none;
      display: flex; align-items: center; gap: 6px;
      transition: all .15s; white-space: nowrap; user-select: none; text-transform: uppercase;
    }
    .tab.active { background: var(--surface); color: var(--text); border-color: var(--border); }
    .tab:hover:not(.active) { color: var(--text); }

    .live-dot {
      width: 7px; height: 7px; background: var(--primary); border-radius: 50%;
      animation: pulse-dot 1.5s ease-in-out infinite; flex-shrink: 0;
    }
    @keyframes pulse-dot {
      0%, 100% { opacity: 1; transform: scale(1); }
      50%       { opacity: .4; transform: scale(.85); }
    }
    .badge {
      font-size: 10px; padding: 1px 7px; border-radius: 9999px;
      font-weight: 700; background: var(--surface2); color: var(--muted);
    }
    .badge.live { background: rgba(232,22,79,.2); color: var(--primary); }

    /* ‚îÄ‚îÄ Content ‚îÄ‚îÄ */
    .content { padding: 20px; max-width: 880px; margin: 0 auto; }

    .error-banner {
      background: rgba(232,22,79,.1); border: 1px solid rgba(232,22,79,.35);
      border-radius: 10px; padding: 12px 16px; margin-bottom: 16px;
      font-size: 12px; font-weight: 600; color: #ff8aab; display: none;
    }

    /* ‚îÄ‚îÄ Competition group ‚îÄ‚îÄ */
    .comp-group { margin-bottom: 28px; }
    .comp-header { display: flex; align-items: center; gap: 10px; padding: 6px 0 10px; border-bottom: 1px solid var(--border); margin-bottom: 10px; }
    .comp-logo { width: 20px; height: 20px; object-fit: contain; flex-shrink: 0; }
    .comp-name { font-size: 10px; font-weight: 800; color: var(--muted); text-transform: uppercase; letter-spacing: 1px; }
    .comp-round { font-size: 10px; font-weight: 500; color: #555; margin-left: 4px; }

    /* ‚îÄ‚îÄ Match card ‚îÄ‚îÄ */
    .match-card {
      background: var(--surface); border: 1px solid var(--border);
      border-radius: 14px; padding: 14px 18px; margin-bottom: 8px;
      display: grid; grid-template-columns: 1fr auto 1fr;
      align-items: center; gap: 10px; cursor: pointer;
      transition: border-color .15s, transform .1s, box-shadow .15s;
    }
    .match-card:hover { border-color: #555; transform: translateY(-1px); box-shadow: 0 4px 16px rgba(0,0,0,.3); }
    .match-card:active { transform: translateY(0); }
    .match-card.live { border-color: rgba(232,22,79,.4); background: linear-gradient(135deg, #220a10 0%, #252523 100%); }
    .match-card.live:hover { border-color: rgba(232,22,79,.7); }

    @keyframes goal-flash {
      0%   { border-color: var(--accent); box-shadow: 0 0 0 2px rgba(255,163,43,.55), 0 0 28px rgba(255,163,43,.2); background: #2b1d00; }
      75%  { border-color: rgba(255,163,43,.35); box-shadow: 0 0 0 1px rgba(255,163,43,.15); }
      100% { box-shadow: none; }
    }
    .match-card.goal-flash,
    .match-card.live.goal-flash { animation: goal-flash 10s ease-out forwards; }

    .team      { display: flex; align-items: center; gap: 10px; }
    .team.away { flex-direction: row-reverse; text-align: right; }
    .team-logo { width: 28px; height: 28px; object-fit: contain; flex-shrink: 0; }
    .team-logo-ph { width: 28px; height: 28px; background: var(--surface2); border-radius: 50%; flex-shrink: 0; }
    .team-name { font-size: 13px; font-weight: 700; color: var(--text); line-height: 1.2; }
    .team-name.winner { color: #fff; }
    .team-name.loser  { color: var(--muted); }

    .match-center { text-align: center; min-width: 94px; }
    .score {
      font-size: 24px; font-weight: 800; color: #fff;
      font-variant-numeric: tabular-nums; letter-spacing: 3px; line-height: 1;
    }
    .match-meta {
      font-size: 10px; font-weight: 700; letter-spacing: .5px; margin-top: 5px;
      display: flex; align-items: center; justify-content: center; gap: 4px;
      text-transform: uppercase;
    }
    .meta-live     { color: var(--primary); }
    .meta-ht       { color: var(--accent); }
    .meta-et       { color: #ce93d8; }
    .meta-finished { color: var(--muted); }
    .meta-sched    { color: #7ab0d4; font-size: 12px; letter-spacing: 0; font-weight: 600; text-transform: none; }
    .vs-text       { font-size: 13px; font-weight: 700; color: var(--muted); }
    .card-hint     { font-size: 9px; color: var(--muted); margin-top: 5px; opacity: 0; transition: opacity .2s; font-weight: 500; }
    .match-card:hover .card-hint { opacity: 1; }

    /* ‚îÄ‚îÄ Empty / Loading ‚îÄ‚îÄ */
    .empty-state { text-align: center; padding: 60px 20px; color: var(--muted); }
    .empty-state .icon { font-size: 44px; margin-bottom: 14px; }
    .empty-state h3 { font-size: 16px; color: var(--text); margin-bottom: 6px; font-weight: 700; }
    .empty-state p  { font-size: 13px; line-height: 1.6; font-weight: 500; }

    .loading { text-align: center; padding: 50px 20px; }
    .spinner {
      width: 28px; height: 28px; border: 3px solid var(--border);
      border-top-color: var(--primary); border-radius: 50%;
      animation: spin .7s linear infinite; margin: 0 auto 14px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .loading p { font-size: 12px; color: var(--muted); font-weight: 600; }

    .footer-info {
      font-size: 10px; color: #444; text-align: center;
      padding: 8px 0 24px; font-weight: 600; letter-spacing: .2px;
      display: flex; justify-content: center; align-items: center; gap: 16px; flex-wrap: wrap;
    }
    .rate-pill {
      background: var(--surface); border: 1px solid var(--border);
      border-radius: 9999px; padding: 2px 10px; font-size: 10px; font-weight: 700;
      color: var(--muted);
    }
    .rate-pill.warn   { color: var(--accent); border-color: rgba(255,163,43,.4); }
    .rate-pill.danger { color: var(--primary); border-color: rgba(232,22,79,.4); }

    /* ‚îÄ‚îÄ Detail Drawer ‚îÄ‚îÄ */
    .overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,.65);
      z-index: 200; opacity: 0; pointer-events: none; transition: opacity .3s;
    }
    .overlay.open { opacity: 1; pointer-events: auto; }

    .drawer {
      position: fixed; top: 0; right: 0; bottom: 0; width: min(500px, 100vw);
      background: var(--surface); border-left: 1px solid var(--border);
      z-index: 201; transform: translateX(100%);
      transition: transform .35s cubic-bezier(.16,1,.3,1);
      display: flex; flex-direction: column; overflow: hidden;
    }
    .drawer.open { transform: translateX(0); }

    .drawer-head {
      background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary-deep) 100%);
      padding: 20px; flex-shrink: 0;
    }
    .drawer-top { display: flex; align-items: center; justify-content: space-between; margin-bottom: 18px; }
    .drawer-comp { display: flex; align-items: center; gap: 8px; }
    .drawer-comp-logo { width: 18px; height: 18px; object-fit: contain; }
    .drawer-comp-name { font-size: 10px; font-weight: 800; color: rgba(255,255,255,.55); text-transform: uppercase; letter-spacing: 1px; }
    .close-btn {
      background: rgba(255,255,255,.12); border: none; color: #fff;
      width: 30px; height: 30px; border-radius: 50%; cursor: pointer; font-size: 15px;
      display: flex; align-items: center; justify-content: center; transition: background .15s; flex-shrink: 0;
    }
    .close-btn:hover { background: rgba(255,255,255,.22); }

    .drawer-score-row { display: grid; grid-template-columns: 1fr auto 1fr; align-items: center; gap: 12px; }
    .d-team      { display: flex; align-items: center; gap: 10px; }
    .d-team.away { flex-direction: row-reverse; text-align: right; }
    .d-logo    { width: 36px; height: 36px; object-fit: contain; flex-shrink: 0; }
    .d-logo-ph { width: 36px; height: 36px; background: rgba(255,255,255,.1); border-radius: 50%; flex-shrink: 0; }
    .d-name { font-size: 13px; font-weight: 700; color: #fff; line-height: 1.2; }
    .d-center { text-align: center; }
    .d-score {
      font-size: 32px; font-weight: 800; color: #fff;
      font-variant-numeric: tabular-nums; letter-spacing: 4px; line-height: 1;
    }
    .d-status {
      font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: .5px;
      margin-top: 6px; display: flex; align-items: center; justify-content: center; gap: 4px;
    }
    .ds-live { color: var(--primary); }
    .ds-ht   { color: var(--accent); }
    .ds-fin  { color: rgba(255,255,255,.5); }
    .ds-sch  { color: rgba(255,255,255,.7); font-size: 13px; letter-spacing: 0; text-transform: none; }

    .drawer-body { flex: 1; overflow-y: auto; padding: 20px; }
    .drawer-body::-webkit-scrollbar { width: 4px; }
    .drawer-body::-webkit-scrollbar-track { background: var(--bg); }
    .drawer-body::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

    .tl-label { font-size: 10px; font-weight: 800; color: var(--muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 14px; }

    .ev-row {
      display: grid; grid-template-columns: 1fr 50px 1fr;
      align-items: center; gap: 6px; min-height: 38px;
      padding: 5px 0; border-bottom: 1px solid var(--border);
    }
    .ev-row:last-child { border-bottom: none; }
    .ev-home { display: flex; align-items: center; justify-content: flex-end; gap: 7px; text-align: right; }
    .ev-away { display: flex; align-items: center; justify-content: flex-start; gap: 7px; }
    .ev-min  { text-align: center; font-size: 10px; font-weight: 800; color: var(--muted); white-space: nowrap; }
    .ev-icon { font-size: 15px; flex-shrink: 0; line-height: 1; }
    .ev-name { font-size: 12px; font-weight: 600; color: var(--text); line-height: 1.3; }
    .ev-sub  { font-size: 10px; color: var(--muted); font-weight: 500; display: block; margin-top: 1px; }
    .ev-tag  { font-size: 9px; color: var(--muted); font-weight: 600; }

    .ht-divider-row { grid-column: 1 / -1; display: flex; justify-content: center; padding: 8px 0; }
    .ht-divider {
      font-size: 10px; font-weight: 700; color: var(--accent);
      background: rgba(255,163,43,.1); border: 1px solid rgba(255,163,43,.25);
      border-radius: 9999px; padding: 3px 14px;
    }

    .no-events { text-align: center; padding: 40px 20px; color: var(--muted); font-size: 13px; font-weight: 600; }
    .d-loading { text-align: center; padding: 40px; }

    @media (max-width: 560px) {
      .header h1 { font-size: 14px; }
      .team-name { font-size: 11px; }
      .score { font-size: 20px; letter-spacing: 2px; }
      .match-card { padding: 12px; gap: 6px; }
      .match-center { min-width: 76px; }
      .team-logo, .team-logo-ph { width: 22px; height: 22px; }
      #apiSetup { flex-direction: column; }
      .drawer { width: 100vw; }
    }
  </style>
</head>
<body>

<!-- Header -->
<div class="header">
  <div class="header-left">
    <span class="header-icon">‚öΩ</span>
    <div>
      <h1>Live Scoreboard</h1>
      <div class="header-sub">API-Football ¬∑ RapidAPI</div>
    </div>
  </div>
  <div class="header-right">
    <div class="refresh-wrap">
      <div class="refresh-ring">
        <svg viewBox="0 0 32 32" width="32" height="32">
          <circle class="ring-bg"  cx="16" cy="16" r="13"/>
          <circle class="ring-arc" id="ringArc" cx="16" cy="16" r="13"/>
        </svg>
      </div>
      <span class="countdown-txt" id="countdownTxt">‚Äì</span>
    </div>
    <button class="btn" onclick="manualRefresh()">‚Üª Refresh</button>
    <button class="btn" onclick="toggleSettings()" title="Settings">‚öô</button>
  </div>
</div>

<!-- API Setup -->
<div id="apiSetup">
  <div class="setup-text">
    <strong>Switch to API-Football (RapidAPI)</strong> ‚Äî free tier, full event data.<br>
    <ol class="setup-steps">
      <li>Sign up free at <a href="https://rapidapi.com/api-sports/api/api-football" target="_blank" rel="noopener">rapidapi.com ‚Üí API-Football</a></li>
      <li>Subscribe to the <strong>Basic (free)</strong> plan ‚Äî 100 req/day</li>
      <li>Copy your <strong>X-RapidAPI-Key</strong> and paste below</li>
    </ol>
  </div>
  <div class="key-row">
    <input type="password" id="apiKeyInput" placeholder="Paste your RapidAPI key‚Ä¶" autocomplete="off">
    <button class="btn-connect" onclick="saveApiKey()">Connect</button>
  </div>
</div>

<!-- Tabs -->
<div class="tabs">
  <div class="tab active" data-tab="all"      onclick="switchTab('all')">All Today</div>
  <div class="tab"        data-tab="live"     onclick="switchTab('live')">
    <span class="live-dot"></span>Live<span class="badge live" id="liveCount">0</span>
  </div>
  <div class="tab"        data-tab="upcoming" onclick="switchTab('upcoming')">Upcoming</div>
  <div class="tab"        data-tab="finished" onclick="switchTab('finished')">Finished</div>
</div>

<!-- Content -->
<div class="content">
  <div class="error-banner" id="errorBanner"></div>
  <div id="container">
    <div class="empty-state">
      <div class="icon">üîë</div>
      <h3>API Key Required</h3>
      <p>Enter your free RapidAPI key above to start seeing live scores.</p>
    </div>
  </div>
  <div class="footer-info" id="footerInfo">
    <span id="lastUpdated"></span>
    <span class="rate-pill" id="ratePill" style="display:none"></span>
  </div>
</div>

<!-- Detail Drawer -->
<div class="overlay" id="overlay" onclick="closeDrawer()"></div>
<div class="drawer" id="drawer">
  <div class="drawer-head">
    <div class="drawer-top">
      <div class="drawer-comp">
        <img class="drawer-comp-logo" id="dCompLogo" src="" alt="" style="display:none">
        <span class="drawer-comp-name" id="dCompName"></span>
      </div>
      <button class="close-btn" onclick="closeDrawer()">‚úï</button>
    </div>
    <div class="drawer-score-row">
      <div class="d-team"      id="dHome"></div>
      <div class="d-center">
        <div class="d-score"  id="dScore"></div>
        <div class="d-status" id="dStatus"></div>
      </div>
      <div class="d-team away" id="dAway"></div>
    </div>
  </div>
  <div class="drawer-body" id="drawerBody">
    <div class="d-loading"><div class="spinner"></div></div>
  </div>
</div>

<script>
  /* ‚îÄ‚îÄ Status sets ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  const LIVE_ST     = new Set(['1H','2H','HT','ET','BT','P','LIVE']);
  const UPCOMING_ST = new Set(['NS','TBD']);
  const FINISHED_ST = new Set(['FT','AET','PEN','AWD','WO']);

  const isLive     = f => LIVE_ST.has(f.fixture.status.short);
  const isUpcoming = f => UPCOMING_ST.has(f.fixture.status.short);
  const isFinished = f => FINISHED_ST.has(f.fixture.status.short);

  /* ‚îÄ‚îÄ Refresh rates ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  const LIVE_TICK = 60;   // 60 s when games are live
  const IDLE_TICK = 600;  // 10 min when nothing live
  const CIRC      = 2 * Math.PI * 13; // ‚âà81.68

  /* ‚îÄ‚îÄ State ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  let apiKey      = localStorage.getItem('apifb_key') || '';
  let allFixtures = [];
  let activeTab   = 'all';
  let countdown   = 0;
  let maxCdown    = IDLE_TICK;
  let timerFetch, timerTick;
  let prevScores  = null;
  const flashing  = new Set();
  let openFixId   = null;

  /* ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  function init() {
    if (apiKey) {
      document.getElementById('apiSetup').style.display = 'none';
      boot();
    } else {
      document.getElementById('apiSetup').style.display = 'flex';
    }
    document.getElementById('apiKeyInput').addEventListener('keydown', e => { if (e.key === 'Enter') saveApiKey(); });
    document.addEventListener('keydown', e => { if (e.key === 'Escape') closeDrawer(); });

    // Pause refresh when tab is hidden to save API quota
    document.addEventListener('visibilitychange', () => {
      if (document.hidden) {
        clearInterval(timerFetch); clearInterval(timerTick);
      } else {
        fetchAndRender(); startCycle();
      }
    });
  }

  function boot() { fetchAndRender(); startCycle(); }

  /* ‚îÄ‚îÄ API key ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  function saveApiKey() {
    const v = document.getElementById('apiKeyInput').value.trim();
    if (!v) return;
    apiKey = v;
    localStorage.setItem('apifb_key', apiKey);
    document.getElementById('apiSetup').style.display = 'none';
    boot();
  }
  function toggleSettings() {
    const el = document.getElementById('apiSetup');
    const vis = el.style.display !== 'none';
    el.style.display = vis ? 'none' : 'flex';
    if (!vis && apiKey) document.getElementById('apiKeyInput').value = apiKey;
  }

  /* ‚îÄ‚îÄ Fetch fixtures ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  async function fetchAndRender() {
    try {
      const today = new Date().toLocaleDateString('en-CA'); // YYYY-MM-DD local
      const res = await fetch(`/api/today?date=${today}`, { headers: { 'X-Api-Key': apiKey } });

      if (res.status === 401 || res.status === 403) throw new Error('Invalid API key ‚Äî check your RapidAPI key.');
      if (res.status === 429) throw new Error('Daily rate limit reached (100 req/day on free plan).');
      if (!res.ok) { const b = await res.json().catch(() => ({})); throw new Error(b.message || `API error ${res.status}`); }

      const data = await res.json();

      // Check for API-level errors
      if (data.errors && Object.keys(data.errors).length) {
        const msg = Object.values(data.errors)[0];
        throw new Error(typeof msg === 'string' ? msg : JSON.stringify(msg));
      }

      const fixtures = data.response || [];
      detectGoals(fixtures);
      allFixtures = fixtures;
      hideError();
      renderTab();
      syncLiveCount();
      updateTimestamp();
      updateRateLimit(
        res.headers.get('x-ratelimit-requests-remaining'),
        res.headers.get('x-ratelimit-requests-limit')
      );
    } catch (err) {
      showError(err.message);
    }
  }

  /* ‚îÄ‚îÄ Goal detection ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  function detectGoals(newFix) {
    if (prevScores === null) { prevScores = scoreMap(newFix); return; }
    for (const f of newFix) {
      if (!isLive(f)) continue;
      const prev = prevScores[f.fixture.id];
      if (!prev) continue;
      const hs = f.goals.home ?? 0, as = f.goals.away ?? 0;
      if (hs > prev.home || as > prev.away) triggerFlash(f.fixture.id);
    }
    prevScores = scoreMap(newFix);
  }
  function scoreMap(fixtures) {
    const m = {};
    for (const f of fixtures) m[f.fixture.id] = { home: f.goals.home ?? 0, away: f.goals.away ?? 0 };
    return m;
  }
  function triggerFlash(id) {
    flashing.add(id);
    setTimeout(() => { flashing.delete(id); renderTab(); }, 10000);
  }

  /* ‚îÄ‚îÄ Cycle ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  function currentTick() { return allFixtures.some(isLive) ? LIVE_TICK : IDLE_TICK; }

  function startCycle() {
    clearInterval(timerFetch); clearInterval(timerTick);
    maxCdown = currentTick();
    countdown = maxCdown;
    drawRing(maxCdown, maxCdown);
    timerFetch = setInterval(() => { fetchAndRender(); restartCycle(); }, maxCdown * 1000);
    timerTick  = setInterval(tick, 1000);
  }
  function restartCycle() {
    clearInterval(timerFetch); clearInterval(timerTick);
    startCycle();
  }
  function tick() {
    countdown = Math.max(0, countdown - 1);
    const label = countdown >= 60 ? `${Math.ceil(countdown/60)}m` : `${countdown}s`;
    document.getElementById('countdownTxt').textContent = label;
    drawRing(countdown, maxCdown);
  }
  function drawRing(cur, max) {
    const arc = document.getElementById('ringArc');
    arc.style.strokeDashoffset = CIRC * (1 - cur / max);
    arc.style.stroke = cur <= 5 ? 'var(--primary)' : 'var(--accent)';
  }
  function manualRefresh() {
    clearInterval(timerFetch); clearInterval(timerTick);
    fetchAndRender(); startCycle();
  }

  /* ‚îÄ‚îÄ Tabs ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  function switchTab(tab) {
    activeTab = tab;
    document.querySelectorAll('.tab').forEach(el => el.classList.toggle('active', el.dataset.tab === tab));
    renderTab();
  }
  function filterFor(tab) {
    if (tab === 'live')     return allFixtures.filter(isLive);
    if (tab === 'upcoming') return allFixtures.filter(isUpcoming);
    if (tab === 'finished') return allFixtures.filter(isFinished);
    return allFixtures;
  }

  /* ‚îÄ‚îÄ Status helper ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  function getStatus(f) {
    const s = f.fixture.status.short;
    const el = f.fixture.status.elapsed;
    if (s === '1H')  return { label: `${el}'`,       cls: 'meta-live',     live: true,  ht: false };
    if (s === '2H')  return { label: `${el}'`,        cls: 'meta-live',     live: true,  ht: false };
    if (s === 'HT')  return { label: 'Half Time',     cls: 'meta-ht',       live: true,  ht: true  };
    if (s === 'ET')  return { label: `${el}' ET`,     cls: 'meta-et',       live: true,  ht: false };
    if (s === 'BT')  return { label: 'Break',         cls: 'meta-ht',       live: true,  ht: true  };
    if (s === 'P')   return { label: 'Penalties',     cls: 'meta-live',     live: true,  ht: false };
    if (s === 'FT')  return { label: 'Full Time',     cls: 'meta-finished', live: false, ht: false };
    if (s === 'AET') return { label: 'AET',           cls: 'meta-finished', live: false, ht: false };
    if (s === 'PEN') return { label: 'FT (Pens)',     cls: 'meta-finished', live: false, ht: false };
    if (s === 'PST') return { label: 'Postponed',     cls: 'meta-finished', live: false, ht: false };
    if (s === 'CANC')return { label: 'Cancelled',     cls: 'meta-finished', live: false, ht: false };
    const t = new Date(f.fixture.date).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    return { label: t, cls: 'meta-sched', live: false, ht: false };
  }

  /* ‚îÄ‚îÄ Render ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  function statusOrder(f) {
    const s = f.fixture.status.short;
    if (s === '1H' || s === '2H' || s === 'ET' || s === 'P') return 0;
    if (s === 'HT' || s === 'BT')                             return 1;
    if (UPCOMING_ST.has(s))                                   return 2;
    return 3;
  }

  function renderTab() {
    const fixtures = filterFor(activeTab);
    if (!fixtures.length) {
      const msgs = {
        all:      ['üì≠', 'No matches today',       'Check back later ‚Äî no games scheduled today.'],
        live:     ['üì∫', 'Nothing live right now', 'No matches currently in progress.'],
        upcoming: ['üïê', 'No upcoming matches',    'All scheduled matches have kicked off.'],
        finished: ['‚úÖ', 'No finished matches yet', 'Completed matches will appear here.'],
      };
      const [icon, title, desc] = msgs[activeTab] || msgs.all;
      return setContainer(`<div class="empty-state"><div class="icon">${icon}</div><h3>${title}</h3><p>${desc}</p></div>`);
    }

    const sorted = [...fixtures].sort((a, b) => {
      const d = statusOrder(a) - statusOrder(b);
      return d !== 0 ? d : new Date(a.fixture.date) - new Date(b.fixture.date);
    });

    const groups = new Map();
    for (const f of sorted) {
      const k = f.league.id;
      if (!groups.has(k)) groups.set(k, { league: f.league, fixtures: [] });
      groups.get(k).fixtures.push(f);
    }

    const ordered = [...groups.values()].sort((a, b) =>
      (b.fixtures.some(isLive) ? 1 : 0) - (a.fixtures.some(isLive) ? 1 : 0)
    );
    setContainer(ordered.map(renderGroup).join(''));
  }

  function renderGroup({ league, fixtures }) {
    const logo = league.logo
      ? `<img class="comp-logo" src="${league.logo}" alt="" onerror="this.style.display='none'">`
      : '';
    return `<div class="comp-group">
      <div class="comp-header">
        ${logo}
        <span class="comp-name">${esc(league.name)}</span>
        <span class="comp-round">${esc(league.round || '')}</span>
      </div>
      ${fixtures.map(renderCard).join('')}
    </div>`;
  }

  function renderCard(f) {
    const id   = f.fixture.id;
    const st   = getStatus(f);
    const sched = isUpcoming(f);
    const fin   = isFinished(f);
    const hs = f.goals.home, as = f.goals.away;
    const homeWin = fin && hs > as;
    const awayWin = fin && as > hs;
    const flash   = flashing.has(id);

    const scoreHtml = sched
      ? `<div class="vs-text">vs</div>`
      : `<div class="score">${hs ?? '-'}&nbsp;‚Äì&nbsp;${as ?? '-'}</div>`;

    let metaHtml;
    if (st.ht) {
      metaHtml = `<div class="match-meta ${st.cls}">${st.label}</div>`;
    } else if (st.live) {
      metaHtml = `<div class="match-meta ${st.cls}"><span class="live-dot"></span>${st.label}</div>`;
    } else if (sched) {
      metaHtml = `<div class="match-meta meta-sched">${st.label}</div>`;
    } else {
      metaHtml = `<div class="match-meta ${st.cls}">${st.label}</div>`;
    }

    const cls = ['match-card', st.live ? 'live' : '', flash ? 'goal-flash' : ''].filter(Boolean).join(' ');
    return `<div class="${cls}" onclick="openDrawer(${id})">
      <div class="team home">
        ${teamLogo(f.teams.home)}
        <span class="team-name ${homeWin ? 'winner' : awayWin ? 'loser' : ''}">${esc(f.teams.home.name)}</span>
      </div>
      <div class="match-center">
        ${scoreHtml}
        ${metaHtml}
        <div class="card-hint">tap for events</div>
      </div>
      <div class="team away">
        ${teamLogo(f.teams.away)}
        <span class="team-name ${awayWin ? 'winner' : homeWin ? 'loser' : ''}">${esc(f.teams.away.name)}</span>
      </div>
    </div>`;
  }

  function teamLogo(team) {
    return team.logo
      ? `<img class="team-logo" src="${team.logo}" alt="" onerror="this.outerHTML='<div class=team-logo-ph></div>'">`
      : `<div class="team-logo-ph"></div>`;
  }

  /* ‚îÄ‚îÄ Detail Drawer ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  async function openDrawer(fixtureId) {
    openFixId = fixtureId;
    const f = allFixtures.find(x => x.fixture.id === fixtureId);
    if (!f) return;

    document.getElementById('overlay').classList.add('open');
    document.getElementById('drawer').classList.add('open');
    document.body.style.overflow = 'hidden';

    fillDrawerHeader(f);

    if (isUpcoming(f)) {
      document.getElementById('drawerBody').innerHTML =
        `<div class="no-events">Match hasn't started yet.</div>`;
      return;
    }

    document.getElementById('drawerBody').innerHTML =
      `<div class="d-loading"><div class="spinner"></div></div>`;

    try {
      const res = await fetch(`/api/events/${fixtureId}`, { headers: { 'X-Api-Key': apiKey } });
      if (!res.ok) throw new Error(`API error ${res.status}`);
      const data = await res.json();
      if (openFixId === fixtureId) fillDrawerBody(f, data.response || []);
    } catch (err) {
      if (openFixId === fixtureId)
        document.getElementById('drawerBody').innerHTML =
          `<div class="no-events">Could not load events: ${esc(err.message)}</div>`;
    }
  }

  function fillDrawerHeader(f) {
    const logo = document.getElementById('dCompLogo');
    if (f.league.logo) { logo.src = f.league.logo; logo.style.display = ''; }
    else logo.style.display = 'none';
    document.getElementById('dCompName').textContent = `${f.league.name}  ¬∑  ${f.league.round || ''}`;

    document.getElementById('dHome').innerHTML =
      `${drawerLogo(f.teams.home)}<span class="d-name">${esc(f.teams.home.name)}</span>`;
    document.getElementById('dAway').innerHTML =
      `${drawerLogo(f.teams.away)}<span class="d-name">${esc(f.teams.away.name)}</span>`;

    const sched = isUpcoming(f);
    const scoreEl = document.getElementById('dScore');
    scoreEl.textContent = sched ? 'vs' : `${f.goals.home ?? '-'} ‚Äì ${f.goals.away ?? '-'}`;
    scoreEl.style.fontSize = sched ? '18px' : '';

    const st = getStatus(f);
    let statusHtml;
    if (st.live && !st.ht) {
      statusHtml = `<span class="live-dot"></span><span class="ds-live">${st.label}</span>`;
    } else if (st.ht) {
      statusHtml = `<span class="ds-ht">${st.label}</span>`;
    } else if (isFinished(f)) {
      statusHtml = `<span class="ds-fin">${st.label}</span>`;
    } else {
      statusHtml = `<span class="ds-sch">${st.label}</span>`;
    }
    document.getElementById('dStatus').innerHTML = statusHtml;
  }

  function drawerLogo(team) {
    return team.logo
      ? `<img class="d-logo" src="${team.logo}" alt="" onerror="this.outerHTML='<div class=d-logo-ph></div>'">`
      : `<div class="d-logo-ph"></div>`;
  }

  function fillDrawerBody(fixture, events) {
    const body   = document.getElementById('drawerBody');
    const homeId = fixture.teams.home.id;
    const htScore = fixture.score?.halftime;

    // Only show goals and cards (skip substitutions / VAR / etc.)
    const relevant = events
      .filter(e => e.type === 'Goal' || e.type === 'Card')
      .sort((a, b) => a.time.elapsed - b.time.elapsed || (a.time.extra||0) - (b.time.extra||0));

    if (!relevant.length) {
      body.innerHTML = `<div class="tl-label">Match Events</div><div class="no-events">No goals or cards recorded yet.</div>`;
      return;
    }

    const rows = [];
    let htInserted = false;

    for (const e of relevant) {
      if (!htInserted && e.time.elapsed > 45) {
        const htTxt = (htScore?.home != null) ? `HT  ${htScore.home} ‚Äì ${htScore.away}` : 'Half Time';
        rows.push(`<div class="ev-row"><div class="ht-divider-row"><span class="ht-divider">${htTxt}</span></div></div>`);
        htInserted = true;
      }
      const row = renderEvent(e, homeId);
      if (row) rows.push(row);
    }

    body.innerHTML = `<div class="tl-label">Match Events</div>${rows.join('')}`;
  }

  function renderEvent(e, homeId) {
    const isHome = e.team.id === homeId;
    const min    = e.time.extra ? `${e.time.elapsed}+${e.time.extra}'` : `${e.time.elapsed}'`;

    let icon, name, sub = '';

    if (e.type === 'Goal') {
      icon = '‚öΩ';
      const tag = e.detail === 'Own Goal' ? ' <span class="ev-tag">(OG)</span>'
                : e.detail === 'Penalty'  ? ' <span class="ev-tag">(P)</span>' : '';
      name = esc(e.player?.name || '‚Äî') + tag;
      // assist.name can literally be null from the API
      sub  = e.assist?.name ? `‚Ü™ ${esc(e.assist.name)}` : '';
    } else if (e.type === 'Card') {
      icon = e.detail === 'Yellow Card'    ? 'üü®'
           : e.detail === 'Red Card'       ? 'üü•'
           : 'üü®üü•'; // Yellow Red Card
      name = esc(e.player?.name || '‚Äî');
    } else {
      return '';
    }

    const label = `<div><span class="ev-name">${name}</span>${sub ? `<span class="ev-sub">${sub}</span>` : ''}</div>`;

    return `<div class="ev-row">
      <div class="ev-home">${isHome  ? `${label}<span class="ev-icon">${icon}</span>` : ''}</div>
      <div class="ev-min">${min}</div>
      <div class="ev-away">${!isHome ? `<span class="ev-icon">${icon}</span>${label}` : ''}</div>
    </div>`;
  }

  function closeDrawer() {
    openFixId = null;
    document.getElementById('overlay').classList.remove('open');
    document.getElementById('drawer').classList.remove('open');
    document.body.style.overflow = '';
  }

  /* ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  const setContainer  = html => document.getElementById('container').innerHTML = html;
  const syncLiveCount = ()   => document.getElementById('liveCount').textContent = allFixtures.filter(isLive).length;

  function updateTimestamp() {
    const t = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
    document.getElementById('lastUpdated').textContent = `Updated: ${t}`;
  }
  function updateRateLimit(remaining, limit) {
    const pill = document.getElementById('ratePill');
    if (remaining == null) { pill.style.display = 'none'; return; }
    pill.style.display = '';
    pill.textContent = `${remaining}/${limit} API calls left today`;
    const r = parseInt(remaining, 10);
    pill.className = 'rate-pill' + (r < 10 ? ' danger' : r < 30 ? ' warn' : '');
  }
  function showError(msg) {
    const el = document.getElementById('errorBanner');
    el.textContent = `‚ö† ${msg}`; el.style.display = 'block';
  }
  function hideError() { document.getElementById('errorBanner').style.display = 'none'; }
  const esc = s => String(s ?? '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');

  init();
</script>
</body>
</html>
